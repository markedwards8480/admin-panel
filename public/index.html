<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 { font-size: 20px; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .user-name { font-size: 14px; opacity: 0.9; }

        .btn-logout {
            background: rgba(255,255,255,0.15);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .btn-logout:hover { background: rgba(255,255,255,0.25); }

        /* Main Layout */
        .main-container {
            display: flex;
            min-height: calc(100vh - 60px);
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            background: white;
            border-right: 1px solid #e5e7eb;
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover { background: #f9fafb; color: #1a1a2e; }
        .nav-item.active {
            background: #eff6ff;
            color: #4a6cf7;
            border-left-color: #4a6cf7;
            font-weight: 500;
        }

        .nav-item svg { width: 20px; height: 20px; fill: currentColor; }

        /* Content Area */
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card h3 { font-size: 14px; color: #6b7280; margin-bottom: 8px; }
        .stat-card .value { font-size: 32px; font-weight: 700; color: #1a1a2e; }

        /* Panels */
        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: none;
        }

        .panel.active { display: block; }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .panel-header h2 { font-size: 18px; color: #1a1a2e; }

        .btn-primary {
            background: linear-gradient(135deg, #4a6cf7 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 108, 247, 0.3);
        }

        /* Table */
        .table-container { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 14px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f9fafb;
        }

        td { font-size: 14px; color: #374151; }

        tr:hover { background: #f9fafb; }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success { background: #d1fae5; color: #059669; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        .badge-info { background: #dbeafe; color: #2563eb; }

        .action-btns { display: flex; gap: 8px; }

        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .btn-icon svg { width: 16px; height: 16px; }
        .btn-edit { background: #dbeafe; color: #2563eb; }
        .btn-edit:hover { background: #bfdbfe; }
        .btn-access { background: #fef3c7; color: #d97706; }
        .btn-access:hover { background: #fde68a; }
        .btn-delete { background: #fee2e2; color: #dc2626; }
        .btn-delete:hover { background: #fecaca; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 { font-size: 18px; }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f3f4f6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            color: #6b7280;
        }

        .modal-body { padding: 24px; }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a6cf7;
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-row .form-group { flex: 1; }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-label input { width: auto; }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Access Checkboxes */
        .access-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .access-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .access-item:last-child { border-bottom: none; }
        .access-item input { width: 18px; height: 18px; }
        .access-item label { flex: 1; cursor: pointer; }

        /* API Key */
        .api-key-display {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .api-key-display input {
            flex: 1;
            font-family: monospace;
            background: #f3f4f6;
        }

        .btn-copy {
            padding: 10px 14px;
            background: #e5e7eb;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 24px;
            color: #6b7280;
        }

        .empty-state svg { width: 48px; height: 48px; opacity: 0.5; margin-bottom: 16px; }

        /* Hidden */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header class="header">
        <h1>Admin Panel</h1>
        <div class="header-right">
            <span class="user-name" id="userName"></span>
            <button class="btn-help" onclick="showHelp()" style="background: #6366f1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 8px;">? Help</button>
            <button class="btn-logout" onclick="logout()">Sign Out</button>
        </div>
    </header>

    <div class="main-container">
        <nav class="sidebar">
            <div class="nav-item active" data-panel="dashboard">
                <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                Dashboard
            </div>
            <div class="nav-item" data-panel="users">
                <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                Users
            </div>
            <div class="nav-item" data-panel="apps">
                <svg viewBox="0 0 24 24"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
                Apps
            </div>
            <div class="nav-item" data-panel="departments">
                <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3V3zm0 10h8v8H3v-8zm10-10h8v8h-8V3zm0 10h8v8h-8v-8z"/></svg>
                Departments
            </div>
            <div class="nav-item" data-panel="activity">
                <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                Activity
            </div>
            <div class="nav-item" data-panel="health">
                <svg viewBox="0 0 24 24"><path d="M19.5 12c0-.23-.01-.45-.03-.68l1.86-1.41c.4-.3.51-.86.26-1.3l-1.87-3.23c-.25-.44-.79-.62-1.25-.42l-2.15.91c-.37-.26-.76-.49-1.17-.68l-.29-2.31c-.06-.5-.49-.88-.99-.88h-3.73c-.51 0-.94.38-1 .88l-.29 2.31c-.41.19-.8.42-1.17.68l-2.15-.91c-.46-.2-1-.02-1.25.42L2.41 8.62c-.25.44-.14.99.26 1.3l1.86 1.41c-.02.22-.03.44-.03.67s.01.45.03.68l-1.86 1.41c-.4.3-.51.86-.26 1.3l1.87 3.23c.25.44.79.62 1.25.42l2.15-.91c.37.26.76.49 1.17.68l.29 2.31c.06.5.49.88.99.88h3.73c.5 0 .93-.38.99-.88l.29-2.31c.41-.19.8-.42 1.17-.68l2.15.91c.46.2 1 .02 1.25-.42l1.87-3.23c.25-.44.14-.99-.26-1.3l-1.86-1.41c.03-.23.04-.45.04-.68zm-7.46 3.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                Health
            </div>
        </nav>

        <main class="content">
            <!-- Dashboard Panel -->
            <div class="panel active" id="panel-dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value" id="stat-users">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Apps</h3>
                        <div class="value" id="stat-apps">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Access Grants</h3>
                        <div class="value" id="stat-assignments">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active This Week</h3>
                        <div class="value" id="stat-active">-</div>
                    </div>
                </div>
            </div>

            <!-- Users Panel -->
            <div class="panel" id="panel-users">
                <div class="panel-header">
                    <h2>Users</h2>
                    <button class="btn-primary" onclick="openUserModal()">+ Add User</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Apps</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Apps Panel -->
            <div class="panel" id="panel-apps">
                <div class="panel-header">
                    <h2>Apps</h2>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button class="btn-secondary" onclick="syncFromRailway()" id="railwaySyncBtn">
                            <span id="railwaySyncText">üöÇ Sync from Railway</span>
                        </button>
                        <button class="btn-primary" onclick="openAppModal()">+ Add App</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Slug</th>
                                <th>URL</th>
                                <th>Department</th>
                                <th>Users</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="appsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Departments Panel -->
            <div class="panel" id="panel-departments">
                <div class="panel-header">
                    <h2>Departments</h2>
                    <button class="btn-primary" onclick="openDeptModal()">+ Add Department</button>
                </div>
                <p style="color: #6b7280; margin-bottom: 16px;">Organize your apps into departments. Drag to reorder. Apps assigned to departments will be grouped in the App Hub.</p>
                <div id="deptList" style="display: flex; flex-direction: column; gap: 8px;"></div>
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 12px;">App ‚Üí Department Assignment</h3>
                    <p style="color: #6b7280; margin-bottom: 16px;">Assign each app to a department, and set its icon and color for the App Hub.</p>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>App</th>
                                    <th>Department</th>
                                    <th>Icon</th>
                                    <th>Color</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="appDeptTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Activity Panel -->
            <div class="panel" id="panel-activity">
                <div class="panel-header">
                    <h2>Login Activity</h2>
                    <button class="btn-secondary" onclick="loadActivity()">‚Üª Refresh</button>
                </div>

                <!-- Activity Stats -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <h3>Logins Today</h3>
                        <div class="value" id="stat-logins-today">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Logins This Week</h3>
                        <div class="value" id="stat-logins-week">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users Today</h3>
                        <div class="value" id="stat-active-today">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users This Week</h3>
                        <div class="value" id="stat-active-week">-</div>
                    </div>
                </div>

                <!-- App Usage -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div class="card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-top: 0; font-size: 16px; color: #1a1a2e;">üìä Most Used Apps</h3>
                        <div id="appUsageList" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    <div class="card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-top: 0; font-size: 16px; color: #1a1a2e;">üåç Login Locations</h3>
                        <div id="locationList" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Recent Activity Table -->
                <div class="card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin-top: 0; font-size: 16px; color: #1a1a2e;">üïê Recent Logins</h3>
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>App</th>
                                    <th>Location</th>
                                    <th>IP Address</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Health Panel -->
            <div class="panel" id="panel-health">
                <div class="panel-header">
                    <h2>System Health</h2>
                    <button class="btn-primary" onclick="runHealthChecks()" id="runHealthBtn">üîç Run Health Checks</button>
                </div>

                <!-- Health Summary -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card" id="health-summary-healthy" style="border-left: 4px solid #22c55e;">
                        <h3>Healthy</h3>
                        <div class="value" id="stat-healthy" style="color: #22c55e;">-</div>
                    </div>
                    <div class="stat-card" id="health-summary-unhealthy" style="border-left: 4px solid #ef4444;">
                        <h3>Unhealthy</h3>
                        <div class="value" id="stat-unhealthy" style="color: #ef4444;">-</div>
                    </div>
                    <div class="stat-card" id="health-summary-unknown" style="border-left: 4px solid #f59e0b;">
                        <h3>Unknown</h3>
                        <div class="value" id="stat-unknown" style="color: #f59e0b;">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Response</h3>
                        <div class="value" id="stat-avg-response">-</div>
                    </div>
                </div>

                <!-- App Status Table -->
                <div class="card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
                    <h3 style="margin-top: 0; font-size: 16px; color: #1a1a2e;">üñ•Ô∏è App Status</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>App</th>
                                    <th>URL</th>
                                    <th>Response Time</th>
                                    <th>Last Check</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="healthTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Data Freshness -->
                <div class="card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin-top: 0; font-size: 16px; color: #1a1a2e;">üìä Data Freshness</h3>
                    <p style="color: #6b7280; margin-bottom: 16px;">Track when data was last updated in your apps. Apps can report their data freshness using the API.</p>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>App</th>
                                    <th>Data Source</th>
                                    <th>Last Updated</th>
                                    <th>Records</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="freshnessTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- User Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="userModalTitle">Add User</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <form id="userForm">
                <div class="modal-body">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="userNameInput" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group" id="passwordGroup">
                        <label>Password <span id="passwordHint" class="hidden">(leave blank to keep current)</span></label>
                        <input type="password" id="userPassword">
                    </div>
                    <div class="form-group" id="autoGenPasswordGroup">
                        <label class="checkbox-label">
                            <input type="checkbox" id="autoGenPassword" checked>
                            Auto-generate password
                        </label>
                        <small style="color: #666; display: block; margin-top: 4px;">A secure password will be generated and shown after saving</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="userIsAdmin">
                                Admin user
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="userIsActive" checked>
                                Active
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- App Modal -->
    <div class="modal-overlay" id="appModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="appModalTitle">Add App</h3>
                <button class="modal-close" onclick="closeModal('appModal')">&times;</button>
            </div>
            <form id="appForm">
                <div class="modal-body">
                    <input type="hidden" id="appId">
                    <div class="form-group">
                        <label>App Name</label>
                        <input type="text" id="appName" required placeholder="e.g., Product Catalog">
                    </div>
                    <div class="form-group">
                        <label>Slug (unique identifier)</label>
                        <input type="text" id="appSlug" required placeholder="e.g., product-catalog" pattern="[a-z0-9-]+">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="appDescription" rows="2" placeholder="Brief description of the app"></textarea>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="appUrl" placeholder="https://your-app.railway.app">
                    </div>
                    <div class="form-group" id="apiKeyGroup" style="display:none;">
                        <label>API Key</label>
                        <div class="api-key-display">
                            <input type="text" id="appApiKey" readonly>
                            <button type="button" class="btn-copy" onclick="copyApiKey()">Copy</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="appIsActive" checked>
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('appModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Save App</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Access Modal -->
    <div class="modal-overlay" id="accessModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="accessModalTitle">Manage Access</h3>
                <button class="modal-close" onclick="closeModal('accessModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="accessUserId">
                <p style="margin-bottom: 16px; color: #6b7280;">Select which apps this user can access:</p>
                <div class="access-list" id="accessList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('accessModal')">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveAccess()">Save Access</button>
            </div>
        </div>
    </div>

    <!-- Railway Sync Modal -->
    <div class="modal-overlay" id="railwayModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Sync from Railway</h3>
                <button class="modal-close" onclick="closeModal('railwayModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="railwayStatus" style="margin-bottom: 16px;"></div>
                
                <div class="form-group">
                    <label>Select Railway Project</label>
                    <select id="railwayProjectSelect" class="form-control" onchange="enableSyncButton()">
                        <option value="">Loading projects...</option>
                    </select>
                </div>

                <div id="railwaySyncResult" style="margin-top: 16px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('railwayModal')">Cancel</button>
                <button type="button" class="btn-primary" id="performSyncBtn" onclick="performRailwaySync()" disabled>
                    Sync Selected Project
                </button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üìñ Admin Panel Quick Guide</h3>
                <button class="modal-close" onclick="closeModal('helpModal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align: left;">
                <h4 style="margin-top: 0; color: #1a1a2e;">üë§ Managing Users</h4>
                <ul style="margin-bottom: 20px; line-height: 1.8;">
                    <li><strong>Add User:</strong> Click "+ Add User". Password auto-generates by default (like "Ocean-Tiger5!")</li>
                    <li><strong>Edit User:</strong> Click the blue ‚úèÔ∏è pencil icon</li>
                    <li><strong>Reset Password:</strong> Click the orange üîë key icon ‚Üí new password shown in popup</li>
                    <li><strong>Manage App Access:</strong> Click the üåê globe icon ‚Üí check which apps user can access</li>
                    <li><strong>Delete User:</strong> Click the red üóëÔ∏è trash icon</li>
                </ul>

                <h4 style="color: #1a1a2e;">üì± Managing Apps</h4>
                <ul style="margin-bottom: 20px; line-height: 1.8;">
                    <li><strong>Add App:</strong> Click "+ Add App" and enter name/URL</li>
                    <li><strong>API Key:</strong> Each app gets a unique API key for authentication</li>
                    <li><strong>Sync from Railway:</strong> Auto-import apps from your Railway project</li>
                </ul>

                <h4 style="color: #1a1a2e;">üîê Password Info</h4>
                <ul style="line-height: 1.8;">
                    <li>Passwords are stored securely (hashed) - they cannot be retrieved</li>
                    <li>Auto-generated passwords use format: <code>Word-Word#!</code></li>
                    <li>If a user forgets their password, use the Reset Password button</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-primary" onclick="closeModal('helpModal')">Got it!</button>
            </div>
        </div>
    </div>

    <!-- Department Modal -->
    <div class="modal-overlay" id="deptModal">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header">
                <h3 id="deptModalTitle">Add Department</h3>
                <button class="modal-close" onclick="closeModal('deptModal')">&times;</button>
            </div>
            <form id="deptForm">
                <div class="modal-body">
                    <input type="hidden" id="deptId">
                    <div class="form-group">
                        <label>Department Name</label>
                        <input type="text" id="deptName" required placeholder="e.g., Operations">
                    </div>
                    <div class="form-group">
                        <label>Sort Order</label>
                        <input type="number" id="deptSortOrder" value="0" min="0" placeholder="0">
                        <small style="color:#6b7280;">Lower numbers appear first in the App Hub</small>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="deptIsActive" checked>
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('deptModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Save Department</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let railwayProjects = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCurrentUser();
            await loadStats();
            setupNavigation();
        });

        async function loadCurrentUser() {
            try {
                const res = await fetch('/api/me');
                if (!res.ok) {
                    window.location.href = '/login';
                    return;
                }
                currentUser = await res.json();
                document.getElementById('userName').textContent = currentUser.name;
            } catch (err) {
                window.location.href = '/login';
            }
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    item.classList.add('active');
                    const panel = document.getElementById('panel-' + item.dataset.panel);
                    panel.classList.add('active');

                    if (item.dataset.panel === 'users') loadUsers();
                    if (item.dataset.panel === 'apps') { loadApps(); checkRailwayStatus(); }
                    if (item.dataset.panel === 'dashboard') loadStats();
                    if (item.dataset.panel === 'departments') loadDepartments();
                    if (item.dataset.panel === 'activity') loadActivity();
                    if (item.dataset.panel === 'health') loadHealth();
                });
            });
        }

        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                document.getElementById('stat-users').textContent = stats.total_users;
                document.getElementById('stat-apps').textContent = stats.total_apps;
                document.getElementById('stat-assignments').textContent = stats.total_assignments;
                document.getElementById('stat-active').textContent = stats.active_users_week;
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        // ============== ACTIVITY ==============
        async function loadActivity() {
            try {
                // Load activity stats
                const statsRes = await fetch('/api/activity/stats');
                const stats = await statsRes.json();
                document.getElementById('stat-logins-today').textContent = stats.logins_today || 0;
                document.getElementById('stat-logins-week').textContent = stats.logins_week || 0;
                document.getElementById('stat-active-today').textContent = stats.unique_users_today || 0;
                document.getElementById('stat-active-week').textContent = stats.unique_users_week || 0;

                // Load app usage
                const appRes = await fetch('/api/activity/by-app');
                const appUsage = await appRes.json();
                document.getElementById('appUsageList').innerHTML = appUsage.length > 0
                    ? appUsage.map(app => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span>${escapeHtml(app.name)}</span>
                            <span style="color: #6b7280;">
                                <strong>${app.logins_week || 0}</strong> this week
                            </span>
                        </div>
                    `).join('')
                    : '<div style="color: #6b7280; padding: 20px; text-align: center;">No activity data yet</div>';

                // Load locations
                const locRes = await fetch('/api/activity/by-location');
                const locations = await locRes.json();
                document.getElementById('locationList').innerHTML = locations.length > 0
                    ? locations.map(loc => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                            <span>üìç ${escapeHtml(loc.city || 'Unknown')}, ${escapeHtml(loc.country || 'Unknown')}</span>
                            <span style="color: #6b7280;">
                                <strong>${loc.login_count}</strong> logins
                            </span>
                        </div>
                    `).join('')
                    : '<div style="color: #6b7280; padding: 20px; text-align: center;">No location data yet</div>';

                // Load recent activity
                const recentRes = await fetch('/api/activity/recent?limit=50');
                const recent = await recentRes.json();
                const tbody = document.getElementById('activityTableBody');
                tbody.innerHTML = recent.length > 0
                    ? recent.map(activity => `
                        <tr>
                            <td><strong>${escapeHtml(activity.user_name)}</strong><br><small style="color:#6b7280">${escapeHtml(activity.user_email)}</small></td>
                            <td>${escapeHtml(activity.app_name)}</td>
                            <td>${activity.city ? `${escapeHtml(activity.city)}, ${escapeHtml(activity.country || '')}` : '<span style="color:#999">Unknown</span>'}</td>
                            <td><small style="font-family: monospace;">${escapeHtml(activity.ip_address || 'N/A')}</small></td>
                            <td>${formatTimeAgo(activity.login_time)}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">No login activity recorded yet. Activity will appear here when users log in to your apps.</td></tr>';

            } catch (err) {
                console.error('Failed to load activity:', err);
            }
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // ============== HEALTH ==============
        async function loadHealth() {
            try {
                // Load health status
                const statusRes = await fetch('/api/health/status');
                const status = await statusRes.json();

                // Calculate summary stats
                let healthy = 0, unhealthy = 0, unknown = 0, totalResponse = 0, responseCount = 0;
                status.forEach(app => {
                    if (app.status === 'healthy') healthy++;
                    else if (app.status === 'unhealthy' || app.status === 'error') unhealthy++;
                    else unknown++;

                    if (app.response_time_ms) {
                        totalResponse += app.response_time_ms;
                        responseCount++;
                    }
                });

                document.getElementById('stat-healthy').textContent = healthy;
                document.getElementById('stat-unhealthy').textContent = unhealthy;
                document.getElementById('stat-unknown').textContent = unknown;
                document.getElementById('stat-avg-response').textContent = responseCount > 0
                    ? Math.round(totalResponse / responseCount) + 'ms'
                    : '-';

                // Render health table
                const tbody = document.getElementById('healthTableBody');
                tbody.innerHTML = status.length > 0
                    ? status.map(app => `
                        <tr>
                            <td>${getStatusBadge(app.status)}</td>
                            <td><strong>${escapeHtml(app.name)}</strong><br><small style="color:#6b7280">${escapeHtml(app.slug)}</small></td>
                            <td><small>${app.url ? `<a href="${escapeHtml(app.url)}" target="_blank">${escapeHtml(app.url)}</a>` : '<span style="color:#999">No URL</span>'}</small></td>
                            <td>${app.response_time_ms ? app.response_time_ms + 'ms' : '-'}</td>
                            <td>${app.check_time ? formatTimeAgo(app.check_time) : 'Never'}</td>
                            <td>${app.error_message ? `<small style="color:#ef4444">${escapeHtml(app.error_message)}</small>` : '-'}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">No apps found. Add apps first, then run health checks.</td></tr>';

                // Load data freshness
                const freshnessRes = await fetch('/api/health/freshness');
                const freshness = await freshnessRes.json();

                const freshnessTbody = document.getElementById('freshnessTableBody');
                freshnessTbody.innerHTML = freshness.length > 0
                    ? freshness.map(item => `
                        <tr>
                            <td><strong>${escapeHtml(item.app_name)}</strong></td>
                            <td>${escapeHtml(item.data_source)}</td>
                            <td>${item.last_updated ? formatTimeAgo(item.last_updated) : 'Never'}</td>
                            <td>${item.record_count ? item.record_count.toLocaleString() : '-'}</td>
                            <td>${getFreshnessBadge(item.last_updated)}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">No data freshness records yet. Apps can report their data freshness using the API.</td></tr>';

            } catch (err) {
                console.error('Failed to load health:', err);
            }
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'healthy':
                    return '<span class="badge badge-success">‚úì Healthy</span>';
                case 'unhealthy':
                    return '<span class="badge badge-danger">‚úó Unhealthy</span>';
                case 'error':
                    return '<span class="badge badge-danger">‚ö† Error</span>';
                case 'no_url':
                    return '<span class="badge" style="background:#f59e0b;color:white;">No URL</span>';
                default:
                    return '<span class="badge" style="background:#6b7280;color:white;">Unknown</span>';
            }
        }

        function getFreshnessBadge(lastUpdated) {
            if (!lastUpdated) {
                return '<span class="badge" style="background:#6b7280;color:white;">No Data</span>';
            }
            const hoursAgo = (Date.now() - new Date(lastUpdated)) / 3600000;
            if (hoursAgo < 24) {
                return '<span class="badge badge-success">Fresh</span>';
            } else if (hoursAgo < 72) {
                return '<span class="badge" style="background:#f59e0b;color:white;">Stale</span>';
            } else {
                return '<span class="badge badge-danger">Outdated</span>';
            }
        }

        async function runHealthChecks() {
            const btn = document.getElementById('runHealthBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Checking...';

            try {
                const res = await fetch('/api/health/check-all', { method: 'POST' });
                const result = await res.json();

                if (result.success) {
                    loadHealth(); // Reload the data
                } else {
                    alert('Health check failed');
                }
            } catch (err) {
                alert('Failed to run health checks');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Run Health Checks';
            }
        }

        // ============== USERS ==============
        async function loadUsers() {
            try {
                const res = await fetch('/api/users');
                const users = await res.json();
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td><strong>${escapeHtml(user.name)}</strong></td>
                        <td>${escapeHtml(user.email)}</td>
                        <td><span class="badge ${user.is_admin ? 'badge-info' : ''}">${user.is_admin ? 'Admin' : 'User'}</span></td>
                        <td>${user.app_count} apps</td>
                        <td><span class="badge ${user.is_active ? 'badge-success' : 'badge-danger'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                        <td class="action-btns">
                            <button class="btn-icon btn-edit" onclick="editUser(${user.id})" title="Edit">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                            </button>
                            <button class="btn-icon btn-access" onclick="manageAccess(${user.id}, '${escapeHtml(user.name)}')" title="Manage App Access">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                            </button>
                            <button class="btn-icon btn-reset" onclick="resetPassword(${user.id}, '${escapeHtml(user.name)}')" title="Reset Password" style="background: #ff9800;">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteUser(${user.id})" title="Delete">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Failed to load users:', err);
            }
        }

        function openUserModal(user = null) {
            document.getElementById('userModalTitle').textContent = user ? 'Edit User' : 'Add User';
            document.getElementById('userId').value = user?.id || '';
            document.getElementById('userNameInput').value = user?.name || '';
            document.getElementById('userEmail').value = user?.email || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false; // Never required since we can auto-gen
            document.getElementById('passwordHint').classList.toggle('hidden', !user);
            document.getElementById('userIsAdmin').checked = user?.is_admin || false;
            document.getElementById('userIsActive').checked = user?.is_active ?? true;

            // Show auto-gen option only for new users
            const autoGenGroup = document.getElementById('autoGenPasswordGroup');
            const passwordGroup = document.getElementById('passwordGroup');
            const autoGenCheckbox = document.getElementById('autoGenPassword');

            if (user) {
                // Editing existing user - hide auto-gen, show password field
                autoGenGroup.style.display = 'none';
                passwordGroup.style.display = 'block';
            } else {
                // New user - show auto-gen option
                autoGenGroup.style.display = 'block';
                autoGenCheckbox.checked = true;
                togglePasswordField();
            }

            document.getElementById('userModal').classList.add('active');
        }

        function togglePasswordField() {
            const autoGen = document.getElementById('autoGenPassword').checked;
            const passwordGroup = document.getElementById('passwordGroup');
            passwordGroup.style.display = autoGen ? 'none' : 'block';
        }

        // Add event listener for auto-gen checkbox
        document.getElementById('autoGenPassword')?.addEventListener('change', togglePasswordField);

        async function editUser(id) {
            const res = await fetch('/api/users');
            const users = await res.json();
            const user = users.find(u => u.id === id);
            if (user) openUserModal(user);
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const data = {
                name: document.getElementById('userNameInput').value,
                email: document.getElementById('userEmail').value,
                is_admin: document.getElementById('userIsAdmin').checked,
                is_active: document.getElementById('userIsActive').checked
            };

            const password = document.getElementById('userPassword').value;
            if (password) {
                data.password = password;
            } else if (!id) {
                // New user with no password - check if auto-gen is selected
                const autoGen = document.getElementById('autoGenPassword').checked;
                if (autoGen) {
                    data.auto_generate_password = true;
                }
            }

            try {
                const res = await fetch(id ? `/api/users/${id}` : '/api/users', {
                    method: id ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert(err.error || 'Failed to save user');
                    return;
                }

                const result = await res.json();

                closeModal('userModal');
                loadUsers();
                loadStats();

                // Show generated password if one was created
                if (result.generated_password) {
                    showGeneratedPassword(result.name, result.email, result.generated_password);
                }
            } catch (err) {
                alert('Failed to save user');
            }
        });

        function showGeneratedPassword(name, email, password) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>User Created Successfully</h3>
                    </div>
                    <div class="modal-body">
                        <p><strong>User:</strong> ${name} (${email})</p>
                        <div class="form-group">
                            <label>Generated Password:</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" value="${password}" readonly id="genPasswordField"
                                    style="font-family: monospace; font-size: 16px; padding: 10px; background: #f5f5f5;">
                                <button type="button" class="btn-secondary" onclick="copyPassword()">Copy</button>
                            </div>
                        </div>
                        <p style="color: #d32f2f; margin-top: 12px;">
                            <strong>Important:</strong> Save this password now. It cannot be retrieved later.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-primary" onclick="this.closest('.modal-overlay').remove()">Done</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function copyPassword() {
            const field = document.getElementById('genPasswordField');
            field.select();
            document.execCommand('copy');
            alert('Password copied to clipboard!');
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            try {
                const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete user');
                    return;
                }
                loadUsers();
                loadStats();
            } catch (err) {
                alert('Failed to delete user');
            }
        }

        async function resetPassword(userId, userName) {
            if (!confirm(`Reset password for ${userName}? This will generate a new password.`)) return;

            try {
                const res = await fetch(`/api/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert(err.error || 'Failed to reset password');
                    return;
                }

                const result = await res.json();
                showGeneratedPassword(result.user.name, result.user.email, result.new_password);
            } catch (err) {
                alert('Failed to reset password');
            }
        }

        async function manageAccess(userId, userName) {
            document.getElementById('accessModalTitle').textContent = `App Access: ${userName}`;
            document.getElementById('accessUserId').value = userId;

            try {
                const res = await fetch(`/api/users/${userId}/access`);
                const apps = await res.json();

                document.getElementById('accessList').innerHTML = apps.map(app => `
                    <div class="access-item">
                        <input type="checkbox" id="access-${app.id}" value="${app.id}" ${app.has_access ? 'checked' : ''}>
                        <label for="access-${app.id}">${escapeHtml(app.name)} <small style="color:#6b7280">(${app.slug})</small></label>
                    </div>
                `).join('') || '<div class="empty-state">No apps available. Add apps first.</div>';

                document.getElementById('accessModal').classList.add('active');
            } catch (err) {
                alert('Failed to load access settings');
            }
        }

        async function saveAccess() {
            const userId = document.getElementById('accessUserId').value;
            const checkboxes = document.querySelectorAll('#accessList input[type="checkbox"]:checked');
            const appIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            try {
                const res = await fetch(`/api/users/${userId}/access`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ app_ids: appIds })
                });

                if (!res.ok) throw new Error();

                closeModal('accessModal');
                loadUsers();
                loadStats();
            } catch (err) {
                alert('Failed to save access settings');
            }
        }

        // ============== APPS ==============
        async function loadApps() {
            try {
                const res = await fetch('/api/apps');
                const apps = await res.json();
                const tbody = document.getElementById('appsTableBody');
                tbody.innerHTML = apps.map(app => `
                    <tr>
                        <td><strong>${escapeHtml(app.name)}</strong></td>
                        <td><code style="background:#f3f4f6;padding:2px 6px;border-radius:4px;">${escapeHtml(app.slug)}</code></td>
                        <td>${app.url ? `<a href="${escapeHtml(app.url)}" target="_blank" style="color:#4a6cf7;">${escapeHtml(app.url)}</a>` : '-'}</td>
                        <td>${app.department_name ? `<span style="background:#eef2ff;color:#4338ca;padding:2px 8px;border-radius:4px;font-size:12px;">${escapeHtml(app.department_name)}</span>` : '<span style="color:#9ca3af;">‚Äî</span>'}</td>
                        <td>${app.user_count} users</td>
                        <td><span class="badge ${app.is_active ? 'badge-success' : 'badge-danger'}">${app.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td class="action-btns">
                            <button class="btn-icon btn-edit" onclick="editApp(${app.id})" title="Edit">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteApp(${app.id})" title="Delete">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Failed to load apps:', err);
            }
        }

        // Sync apps from Railway
        async function syncFromRailway() {
            openModal('railwayModal');
            document.getElementById('railwaySyncResult').innerHTML = '';
            document.getElementById('railwayStatus').innerHTML = '<p>Checking Railway connection...</p>';
            
            // Check Railway status
            try {
                const statusRes = await fetch('/api/railway/status');
                const status = await statusRes.json();
                
                if (!status.connected) {
                    document.getElementById('railwayStatus').innerHTML = `
                        <div style="padding: 12px; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 6px; color: #991b1b;">
                            <strong>Railway Not Connected:</strong> ${status.message}
                            <br><small>Please add RAILWAY_API_TOKEN to your environment variables.</small>
                        </div>
                    `;
                    document.getElementById('railwayProjectSelect').innerHTML = '<option value="">Railway not configured</option>';
                    return;
                }

                document.getElementById('railwayStatus').innerHTML = `
                    <div style="padding: 12px; background: #d1fae5; border: 1px solid #6ee7b7; border-radius: 6px; color: #065f46;">
                        <strong>‚úì Connected to Railway</strong> (${status.email})
                    </div>
                `;

                // Load projects
                await loadRailwayProjects();
            } catch (err) {
                console.error('Railway status check failed:', err);
                document.getElementById('railwayStatus').innerHTML = `
                    <div style="padding: 12px; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 6px; color: #991b1b;">
                        Failed to connect to Railway: ${err.message}
                    </div>
                `;
            }
        }

        async function loadRailwayProjects() {
            try {
                document.getElementById('railwayProjectSelect').innerHTML = '<option value="">Loading projects...</option>';
                
                const res = await fetch('/api/railway/projects');
                railwayProjects = await res.json();
                
                const select = document.getElementById('railwayProjectSelect');
                select.innerHTML = '<option value="">Select a project...</option>';
                
                railwayProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
                
                if (railwayProjects.length === 0) {
                    select.innerHTML = '<option value="">No projects found</option>';
                }
            } catch (err) {
                console.error('Failed to load Railway projects:', err);
                document.getElementById('railwayProjectSelect').innerHTML = '<option value="">Error loading projects</option>';
                alert('Failed to load Railway projects: ' + err.message);
            }
        }

        function enableSyncButton() {
            const projectId = document.getElementById('railwayProjectSelect').value;
            document.getElementById('performSyncBtn').disabled = !projectId;
        }

        async function performRailwaySync() {
            const projectId = document.getElementById('railwayProjectSelect').value;
            if (!projectId) return;

            const projectName = railwayProjects.find(p => p.id === projectId)?.name || projectId;
            const btn = document.getElementById('performSyncBtn');
            
            btn.disabled = true;
            btn.textContent = 'Syncing...';
            document.getElementById('railwaySyncResult').innerHTML = `<p>Syncing project "${projectName}"...</p>`;

            try {
                const res = await fetch(`/api/railway/sync/${projectId}`, {
                    method: 'POST'
                });

                const result = await res.json();

                if (result.success) {
                    document.getElementById('railwaySyncResult').innerHTML = `
                        <div style="padding: 12px; background: #d1fae5; border: 1px solid #6ee7b7; border-radius: 6px; color: #065f46;">
                            <strong>‚úì Success!</strong> ${result.message}
                            <ul style="margin: 8px 0 0 20px;">
                                <li>${result.synced} new apps added</li>
                                <li>${result.skipped} existing apps updated</li>
                            </ul>
                        </div>
                    `;
                    // Reload apps table
                    loadApps();
                    loadStats();
                } else {
                    throw new Error(result.error || 'Sync failed');
                }
            } catch (err) {
                console.error('Railway sync failed:', err);
                document.getElementById('railwaySyncResult').innerHTML = `
                    <div style="padding: 12px; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 6px; color: #991b1b;">
                        <strong>Error:</strong> ${err.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sync Selected Project';
            }
        }

        // Check Railway connection status on load
        async function checkRailwayStatus() {
            try {
                const res = await fetch('/api/railway/status');
                const data = await res.json();
                const btn = document.getElementById('railwaySyncBtn');

                if (!data.connected) {
                    btn.title = data.message || 'Railway not connected';
                    btn.style.opacity = '0.6';
                } else {
                    btn.title = 'Connected as: ' + data.email;
                }
            } catch (err) {
                console.error('Failed to check Railway status:', err);
            }
        }

        let currentEditingApp = null;

        function openAppModal(app = null) {
            currentEditingApp = app;
            document.getElementById('appModalTitle').textContent = app ? 'Edit App' : 'Add App';
            document.getElementById('appId').value = app?.id || '';
            document.getElementById('appName').value = app?.name || '';
            document.getElementById('appSlug').value = app?.slug || '';
            document.getElementById('appSlug').readOnly = !!app;
            document.getElementById('appDescription').value = app?.description || '';
            document.getElementById('appUrl').value = app?.url || '';
            document.getElementById('appIsActive').checked = app?.is_active ?? true;

            if (app?.api_key) {
                document.getElementById('apiKeyGroup').style.display = 'block';
                document.getElementById('appApiKey').value = app.api_key;
            } else {
                document.getElementById('apiKeyGroup').style.display = 'none';
            }

            document.getElementById('appModal').classList.add('active');
        }

        async function editApp(id) {
            const res = await fetch('/api/apps');
            const apps = await res.json();
            const app = apps.find(a => a.id === id);
            if (app) openAppModal(app);
        }

        document.getElementById('appForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('appId').value;
            const data = {
                name: document.getElementById('appName').value,
                slug: document.getElementById('appSlug').value,
                description: document.getElementById('appDescription').value,
                url: document.getElementById('appUrl').value,
                is_active: document.getElementById('appIsActive').checked
            };

            try {
                const res = await fetch(id ? `/api/apps/${id}` : '/api/apps', {
                    method: id ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert(err.error || 'Failed to save app');
                    return;
                }

                const savedApp = await res.json();

                // Show API key for new apps
                if (!id && savedApp.api_key) {
                    alert('App created! Copy this API key (shown only once):\n\n' + savedApp.api_key);
                }

                closeModal('appModal');
                loadApps();
                loadStats();
            } catch (err) {
                alert('Failed to save app');
            }
        });

        async function deleteApp(id) {
            if (!confirm('Are you sure you want to delete this app? All user access will be revoked.')) return;

            try {
                const res = await fetch(`/api/apps/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete app');
                    return;
                }
                loadApps();
                loadStats();
            } catch (err) {
                alert('Failed to delete app');
            }
        }

        function copyApiKey() {
            const input = document.getElementById('appApiKey');
            input.select();
            document.execCommand('copy');
            alert('API key copied!');
        }

        // ============== UTILITIES ==============
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // DEPARTMENTS MANAGEMENT
        // ============================================
        let allDepartments = [];
        const ICON_OPTIONS = ['üì±','üìä','üì¶','üí∞','üè≠','üîß','üìã','üöÄ','üé®','üìà','üõí','üìù','‚öôÔ∏è','üè¢','üìë','üîç','üíº','üìû','üóÇÔ∏è','‚úâÔ∏è'];
        const COLOR_OPTIONS = [
            { name: 'Blue', value: 'color-blue', hex: '#007AFF' },
            { name: 'Purple', value: 'color-purple', hex: '#AF52DE' },
            { name: 'Green', value: 'color-green', hex: '#34C759' },
            { name: 'Orange', value: 'color-orange', hex: '#FF9500' },
            { name: 'Red', value: 'color-red', hex: '#FF3B30' },
            { name: 'Teal', value: 'color-teal', hex: '#5AC8FA' },
            { name: 'Pink', value: 'color-pink', hex: '#FF2D55' },
            { name: 'Indigo', value: 'color-indigo', hex: '#5856D6' },
        ];

        async function loadDepartments() {
            try {
                const [deptRes, appsRes] = await Promise.all([
                    fetch('/api/departments'),
                    fetch('/api/apps')
                ]);
                allDepartments = await deptRes.json();
                const apps = await appsRes.json();

                // Render department cards
                const deptList = document.getElementById('deptList');
                if (allDepartments.length === 0) {
                    deptList.innerHTML = '<div style="padding:32px;text-align:center;color:#6b7280;background:#f9fafb;border-radius:8px;">No departments yet. Create one to start organizing your apps in the Hub.</div>';
                } else {
                    deptList.innerHTML = allDepartments.map(d => {
                        const deptApps = apps.filter(a => a.department_id === d.id);
                        return `
                        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="font-size:18px;color:#6b7280;">${d.sort_order}</span>
                                <div>
                                    <strong>${escapeHtml(d.name)}</strong>
                                    <span style="color:#6b7280;margin-left:8px;">(${deptApps.length} app${deptApps.length !== 1 ? 's' : ''})</span>
                                    ${!d.is_active ? '<span class="badge badge-danger" style="margin-left:8px;">Inactive</span>' : ''}
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button class="btn-icon btn-edit" onclick="editDept(${d.id})" title="Edit">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                </button>
                                <button class="btn-icon btn-delete" onclick="deleteDept(${d.id})" title="Delete">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                </button>
                            </div>
                        </div>`;
                    }).join('');
                }

                // Render app‚Üídepartment assignment table
                const tbody = document.getElementById('appDeptTableBody');
                tbody.innerHTML = apps.map(app => {
                    const deptOptions = allDepartments.map(d => 
                        `<option value="${d.id}" ${app.department_id === d.id ? 'selected' : ''}>${escapeHtml(d.name)}</option>`
                    ).join('');
                    const iconOptions = ICON_OPTIONS.map(i => 
                        `<option value="${i}" ${(app.icon || 'üì±') === i ? 'selected' : ''}>${i}</option>`
                    ).join('');
                    const colorOptions = COLOR_OPTIONS.map(c => 
                        `<option value="${c.value}" ${(app.color || 'color-blue') === c.value ? 'selected' : ''} style="color:${c.hex}">${c.name}</option>`
                    ).join('');
                    return `
                    <tr>
                        <td><strong>${escapeHtml(app.name)}</strong></td>
                        <td>
                            <select onchange="updateAppDept(${app.id}, this.value)" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;">
                                <option value="">‚Äî None ‚Äî</option>
                                ${deptOptions}
                            </select>
                        </td>
                        <td>
                            <select onchange="updateAppIcon(${app.id}, this.value)" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:16px;">
                                ${iconOptions}
                            </select>
                        </td>
                        <td>
                            <select onchange="updateAppColor(${app.id}, this.value)" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;">
                                ${colorOptions}
                            </select>
                        </td>
                        <td>
                            <span style="display:inline-block;width:24px;height:24px;border-radius:6px;background:${(COLOR_OPTIONS.find(c => c.value === (app.color || 'color-blue'))?.hex) || '#007AFF'};vertical-align:middle;"></span>
                        </td>
                    </tr>`;
                }).join('');
            } catch (err) {
                console.error('Failed to load departments:', err);
            }
        }

        function openDeptModal(dept = null) {
            document.getElementById('deptModalTitle').textContent = dept ? 'Edit Department' : 'Add Department';
            document.getElementById('deptId').value = dept?.id || '';
            document.getElementById('deptName').value = dept?.name || '';
            document.getElementById('deptSortOrder').value = dept?.sort_order ?? (allDepartments.length + 1);
            document.getElementById('deptIsActive').checked = dept?.is_active ?? true;
            document.getElementById('deptModal').classList.add('active');
        }

        async function editDept(id) {
            const dept = allDepartments.find(d => d.id === id);
            if (dept) openDeptModal(dept);
        }

        document.getElementById('deptForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('deptId').value;
            const data = {
                name: document.getElementById('deptName').value,
                sort_order: parseInt(document.getElementById('deptSortOrder').value) || 0,
                is_active: document.getElementById('deptIsActive').checked
            };
            try {
                const res = await fetch(id ? `/api/departments/${id}` : '/api/departments', {
                    method: id ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) { const err = await res.json(); alert(err.error || 'Failed to save'); return; }
                closeModal('deptModal');
                loadDepartments();
            } catch (err) { alert('Failed to save department'); }
        });

        async function deleteDept(id) {
            const dept = allDepartments.find(d => d.id === id);
            if (!confirm(`Delete "${dept?.name}"? Apps in this department will become unassigned.`)) return;
            try {
                const res = await fetch(`/api/departments/${id}`, { method: 'DELETE' });
                if (!res.ok) { const err = await res.json(); alert(err.error || 'Failed to delete'); return; }
                loadDepartments();
            } catch (err) { alert('Failed to delete department'); }
        }

        async function updateAppDept(appId, deptId) {
            await updateAppField(appId, { department_id: deptId || null });
        }
        async function updateAppIcon(appId, icon) {
            await updateAppField(appId, { icon });
        }
        async function updateAppColor(appId, color) {
            await updateAppField(appId, { color });
            loadDepartments(); // refresh color swatches
        }

        async function updateAppField(appId, fields) {
            try {
                // Fetch current app data first
                const appsRes = await fetch('/api/apps');
                const apps = await appsRes.json();
                const app = apps.find(a => a.id === appId);
                if (!app) return;

                const data = {
                    name: app.name,
                    slug: app.slug,
                    description: app.description || '',
                    url: app.url || '',
                    icon: app.icon || 'üì±',
                    color: app.color || 'color-blue',
                    department_id: app.department_id,
                    is_active: app.is_active,
                    ...fields
                };

                const res = await fetch(`/api/apps/${appId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) { const err = await res.json(); alert(err.error || 'Failed to update'); }
            } catch (err) { console.error('Failed to update app:', err); }
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('active');
            });
        });
    </script>
</body>
</html>
